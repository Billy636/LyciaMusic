# 项目结构与功能说明文档 (Updated 2025-12-31)

## 📁 目录树 (Directory Tree)

```plaintext
my-cloud-music/
├── src/                        # 前端核心源码 (Vue 3 + TS)
│   ├── assets/                 # 静态资源 (图片, 矢量图标)
│   ├── components/             # UI 组件库
│   │   ├── common/             # 通用基础组件 (Toast, Modal, 拖拽镜像)
│   │   ├── layout/             # 框架布局组件
│   │   │   ├── GlobalBackground.vue  # [核心] 多模式背景渲染 (流光/模糊/自定义)
│   │   │   ├── Sidebar.vue           # 侧边导航栏
│   │   │   ├── PlayerFooter.vue      # 底部播放控制条
│   │   │   └── TitleBar.vue          # 自定义窗口标题栏
│   │   ├── overlays/           # 弹出层/右键菜单 (歌曲菜单, 歌单分配)
│   │   ├── player/             # 播放器专用组件 (歌词, 播放详情, 队列列表)
│   │   ├── settings/           # 设置面板组件
│   │   └── song-list/          # 歌曲列表/表格核心组件
│   ├── composables/            # 组合式逻辑 (状态管理 & 业务逻辑)
│   │   ├── player.ts           # [核心] 播放器行为控制 (播放/跳转/列表管理)
│   │   ├── playerState.ts      # [核心] 全局响应式状态 (包含主题/当前歌曲/颜色)
│   │   ├── colorExtraction.ts  # [核心] 封面颜色提取与 HSL 算法处理
│   │   ├── lyrics.ts           # 歌词同步逻辑
│   │   ├── settings.ts         # 设置持久化与同步
│   │   └── toast.ts            # 全局通知调度
│   ├── router/                 # 路由配置 (Vue Router)
│   ├── types/                  # 全局 TypeScript 类型定义
│   ├── views/                  # 页面级视图 (首页, 收藏, 歌手, 专辑)
│   ├── App.vue                 # 应用根入口 (主题应用, 全局组件挂载)
│   ├── main.ts                 # Vue 实例初始化
│   └── style.css               # 全局样式 (包含 Tailwind CSS 指令 & 启动背景修复)
├── src-tauri/                  # 后端核心源码 (Rust / Tauri v2.0)
│   ├── src/
│   │   ├── main.rs             # 程序入口
│   │   ├── lib.rs              # [核心] 指令注册、系统托盘逻辑、插件初始化
│   │   ├── music.rs            # [核心] 文件扫描、封面提取、文件操作指令
│   │   ├── player.rs           # [核心] 后端音频引擎 (基于 rodio)
│   │   ├── database.rs         # 数据持久化 (配置存储)
│   │   └── error.rs            # 统一错误处理模块
│   └── tauri.conf.json         # Tauri 配置文件 (窗口配置, 权限声明)
└── package.json                # 项目依赖与编译脚本
```

---

## 🛠️ 核心模块说明

### 1. 播放器核心 (Player Core)
*   **前端 (`src/composables/player.ts` & `playerState.ts`)**: 驱动 UI 更新，处理播放队列逻辑，调用后端指令。
*   **后端 (`src-tauri/src/player.rs`)**: 负责真实的音频流解码与输出，处理设备播放与进度反馈。

### 2. 背景渲染系统 (Background System)
*   **GlobalBackground.vue**: 负责渲染三种模式：
    *   **灵动流光 (Flow)**: 基于封面提取的多色网格动画。
    *   **静态模糊 (Blur)**: 封面大比例缩放 + 高斯模糊。
    *   **自定义皮肤 (Custom)**: 用户上传图片并支持手动调节模糊度/透明度。
*   **colorExtraction.ts**: 使用 Canvas 采样封面，通过 HSL 聚类算法提取高质量“淡水彩”色值，为流光背景提供色彩输入。

### 3. 音乐库管理 (Music Library)
*   **music.rs**: 高性能后端扫描逻辑，支持封面图实时缓存与缩略图生成。
*   **SongTable.vue**: 前端展示核心，支持拖拽排序、批量移动及右键交互。

### 4. 系统集成 (System Integration)
*   **lib.rs**: 
    *   **系统托盘**: 实现窗口最小化到托盘、右键菜单控制。
    *   **多线程限制**: 引入信号量 (Semaphore) 限制图片处理并发，防止冷启动时 CPU 占用过高。

---

## 📍 最近修改的核心组件 (Key Updates)

*   **GlobalBackground.vue**: 
    *   重构了模板结构，使用 `<transition>` 实现不同背景模式间的平滑切换。
    *   增加了“纯白/纯黑”兜底层，彻底解决背景加载前的色块问题。
*   **colorExtraction.ts**:
    *   优化了 HSL 清洗逻辑：强制执行 `[80, 95]` 明度约束，确保流光背景始终呈现高雅的“淡色系”视觉。
    *   移除了硬编码的紫色 fallback，改为中性灰色。
*   **playerState.ts**:
    *   **[紫色闪屏修复]**: 将 `dominantColors` 的初始状态设为 `transparent`，配合全局 CSS 实现冷启动视觉对齐。
*   **style.css**:
    *   添加了 `body` 的 `prefers-color-scheme` 适配，确保 WebView 渲染前窗口背景色与系统主题一致。
*   **lib.rs**:
    *   迁移至 Tauri v2 API 风格，完成了系统托盘 (TrayIcon) 和 菜单 (Menu) 的逻辑重写。

---

## ⚠️ 开发注意事项 (Important Notes)

*   **Tauri v2.0**: 请务必使用 `tauri::webview::WebviewWindow` 相关 API。窗口配置不再支持 `background` 属性。
*   **响应式约定**: 所有的全局 UI 变量（如背景透明度、主题模式）都通过 `settings` 响应式对象同步，任何对设置的修改都会通过 `watch` 自动应用到 `App.vue` 或 `GlobalBackground.vue`。
*   **错误处理**: 后端指令返回 `Result<T, CommandError>`，前端在 `player.ts` 中通过统一的 Catch 块处理并展示 `Toast` 通知。
